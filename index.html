<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edye Variable Editor</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .empty-field {
            border-color: #FF6600 !important;
            border-width: 2px !important;
        }
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        .firebase-connected {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .firebase-disconnected {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .firebase-saving {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fed7aa;
        }
    </style>
    
    <script>
        // TODO: Reemplaza con tu configuración de Firebase
        const firebaseConfig = {
  apiKey: "AIzaSyCcbWLknBVVmf0ra_afF0FGbeFFI17rals",
  authDomain: "edye-figma-variables-editor.firebaseapp.com",
  projectId: "edye-figma-variables-editor",
  storageBucket: "edye-figma-variables-editor.firebasestorage.app",
  messagingSenderId: "84595194424",
  appId: "1:84595194424:web:e3dc8268d91171f0f004cd"
};

        // Inicializar Firebase v8
        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }
    </script>
</head>
<body>
    <div id="root"></div>
    
    <!-- Firebase Status Indicator -->
    <div id="firebase-status" class="firebase-status firebase-disconnected">
        🔴 Connecting...
    </div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // Icons (same as before)
        const GripVertical = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="9" cy="12" r="1"></circle>
                <circle cx="9" cy="5" r="1"></circle>
                <circle cx="9" cy="19" r="1"></circle>
                <circle cx="15" cy="12" r="1"></circle>
                <circle cx="15" cy="5" r="1"></circle>
                <circle cx="15" cy="19" r="1"></circle>
            </svg>
        );

        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Upload = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17,8 12,3 7,8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const Settings = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="m12 1 1.4 1.4a2 2 0 0 0 1.4.6h2a2 2 0 0 1 2 2v2a2 2 0 0 0 .6 1.4L21 12l-1.4 1.4a2 2 0 0 0-.6 1.4v2a2 2 0 0 1-2 2h-2a2 2 0 0 0-1.4.6L12 23l-1.4-1.4a2 2 0 0 0-1.4-.6H7a2 2 0 0 1-2-2v-2a2 2 0 0 0-.6-1.4L3 12l1.4-1.4a2 2 0 0 0 .6-1.4V7a2 2 0 0 1 2-2h2a2 2 0 0 0 1.4-.6L12 1Z"></path>
            </svg>
        );

        const FolderOpen = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                <path d="M2 6h20v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6z"></path>
            </svg>
        );

        const Save = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17,21 17,13 7,13 7,21"></polyline>
                <polyline points="7,3 7,8 15,8"></polyline>
            </svg>
        );

        const X = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const ChevronDown = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="6,9 12,15 18,9"></polyline>
            </svg>
        );

        const Share = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
            </svg>
        );

        const Copy = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        );

        const Cloud = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
            </svg>
        );

        const FigmaVariablesEditor = () => {
            const [collectionName, setCollectionName] = useState('Languages');
            const [modes, setModes] = useState(['SPA', 'POR', 'ENG']);
            const [variables, setVariables] = useState([
                {
                    id: '1',
                    name: 'kicker',
                    values: {
                        'SPA': 'Future Explorers!',
                        'POR': 'Exploradores do Futuro!',
                        'ENG': 'Future Explorers!'
                    },
                    charLimit: 50
                }
            ]);

            const [draggedItem, setDraggedItem] = useState(null);
            const [editingLimit, setEditingLimit] = useState(null);
            const [savedTemplates, setSavedTemplates] = useState([]);
            const [savedProjects, setSavedProjects] = useState([]);
            const [showTemplateModal, setShowTemplateModal] = useState(false);
            const [showProjectModal, setShowProjectModal] = useState(false);
            const [showOpenModal, setShowOpenModal] = useState(false);
            const [showOpenTemplateModal, setShowOpenTemplateModal] = useState(false);
            const [showOpenFirebaseModal, setShowOpenFirebaseModal] = useState(false);
            const [firebaseProjects, setFirebaseProjects] = useState([]);
            const [showExportMenu, setShowExportMenu] = useState(false);
            const [showImportMenu, setShowImportMenu] = useState(false);
            const [templateName, setTemplateName] = useState('');
            const [projectName, setProjectName] = useState('');
            const [currentProject, setCurrentProject] = useState(null);
            const fileInputRef = useRef(null);
            const excelInputRef = useRef(null);

            // Firebase specific states
            const [firebaseStatus, setFirebaseStatus] = useState('disconnected');
            const [showShareModal, setShowShareModal] = useState(false);
            const [shareableLink, setShareableLink] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);
            const [lastSaved, setLastSaved] = useState(null);
            const autoSaveTimeoutRef = useRef(null);
            const unsubscribeRef = useRef(null);

            // Firebase helper functions
            const updateFirebaseStatus = (status) => {
                setFirebaseStatus(status);
                const statusEl = document.getElementById('firebase-status');
                if (statusEl) {
                    statusEl.className = `firebase-status firebase-${status}`;
                    switch(status) {
                        case 'connected':
                            statusEl.textContent = '🟢 Connected';
                            break;
                        case 'saving':
                            statusEl.textContent = '🟡 Saving...';
                            break;
                        case 'disconnected':
                            statusEl.textContent = '🔴 Disconnected';
                            break;
                    }
                }
            };

            // Generate unique project ID
            const generateProjectId = () => {
                return Math.random().toString(36).substr(2, 9);
            };

            // Save to Firebase v8
            const saveToFirebase = async (projectData, projectId = null) => {
                if (!db) {
                    console.error('Firebase not initialized');
                    updateFirebaseStatus('disconnected');
                    return null;
                }

                try {
                    updateFirebaseStatus('saving');
                    
                    const id = projectId || generateProjectId();
                    
                    const dataToSave = {
                        ...projectData,
                        id,
                        updatedAt: new Date().toISOString(),
                        lastModified: Date.now()
                    };
                    
                    await db.collection('projects').doc(id).set(dataToSave);
                    
                    updateFirebaseStatus('connected');
                    setLastSaved(new Date().toLocaleTimeString());
                    
                    return id;
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                    updateFirebaseStatus('disconnected');
                    alert('Error saving to Firebase: ' + error.message);
                    return null;
                }
            };

            // Load all Firebase projects
            const loadAllFirebaseProjects = async () => {
                if (!db) {
                    console.error('Firebase not initialized');
                    return [];
                }

                try {
                    const querySnapshot = await db.collection('projects')
                        .orderBy('updatedAt', 'desc')
                        .limit(50)
                        .get();
                    
                    const projects = [];
                    querySnapshot.forEach((doc) => {
                        projects.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    return projects;
                } catch (error) {
                    console.error('Error loading Firebase projects:', error);
                    return [];
                }
            };

            // Open Firebase projects modal
            const openFirebaseProjects = async () => {
                setShowOpenFirebaseModal(true);
                const projects = await loadAllFirebaseProjects();
                setFirebaseProjects(projects);
            };

            // Load Firebase project
            const loadFirebaseProject = async (project) => {
                // Unsubscribe from current Firebase project if any
                if (unsubscribeRef.current) {
                    unsubscribeRef.current();
                    unsubscribeRef.current = null;
                }

                setCollectionName(project.collectionName || 'Languages');
                setModes(project.modes || ['SPA', 'POR', 'ENG']);
                
                const newVariables = project.variables ? project.variables.map((v, index) => ({
                    ...v,
                    id: v.id || index.toString()
                })) : [];
                
                setVariables(newVariables);
                
                setCurrentProject({
                    ...project,
                    isFirebase: true
                });
                
                subscribeToProject(project.id);
                setShowOpenFirebaseModal(false);
                
                alert(`Firebase project "${project.name}" loaded!`);
            };

            // Delete Firebase project
            const deleteFirebaseProject = async (projectId) => {
                if (!db) return;
                
                if (confirm('Are you sure you want to delete this project from Firebase? This action cannot be undone.')) {
                    try {
                        await db.collection('projects').doc(projectId).delete();
                        
                        // Refresh the list
                        const projects = await loadAllFirebaseProjects();
                        setFirebaseProjects(projects);
                        
                        // If current project is deleted, clear it
                        if (currentProject && currentProject.id === projectId) {
                            setCurrentProject(null);
                            if (unsubscribeRef.current) {
                                unsubscribeRef.current();
                                unsubscribeRef.current = null;
                            }
                        }
                        
                        alert('Project deleted from Firebase');
                    } catch (error) {
                        console.error('Error deleting project:', error);
                        alert('Error deleting project: ' + error.message);
                    }
                }
            };
            const loadFromFirebase = async (projectId) => {
                if (!db) {
                    console.error('Firebase not initialized');
                    return null;
                }

                try {
                    const docRef = await db.collection('projects').doc(projectId).get();
                    
                    if (docRef.exists) {
                        return docRef.data();
                    } else {
                        console.error('No project found with ID:', projectId);
                        return null;
                    }
                } catch (error) {
                    console.error('Error loading from Firebase:', error);
                    return null;
                }
            };

            // Subscribe to real-time updates v8
            const subscribeToProject = (projectId) => {
                if (!db || !projectId) return;

                try {
                    const unsubscribe = db.collection('projects').doc(projectId).onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            
                            // Only update if data is newer than our local changes
                            if (data.lastModified && (!currentProject?.lastModified || data.lastModified > currentProject.lastModified)) {
                                setCollectionName(data.collectionName || 'Languages');
                                setModes(data.modes || ['SPA', 'POR', 'ENG']);
                                
                                const newVariables = data.variables ? data.variables.map((v, index) => ({
                                    ...v,
                                    id: v.id || index.toString()
                                })) : [];
                                
                                setVariables(newVariables);
                                
                                setCurrentProject({
                                    ...data,
                                    isFirebase: true
                                });
                                
                                console.log('Project updated from Firebase:', data.id);
                            }
                        }
                    }, (error) => {
                        console.error('Error in Firebase subscription:', error);
                        updateFirebaseStatus('disconnected');
                    });
                    
                    unsubscribeRef.current = unsubscribe;
                    updateFirebaseStatus('connected');
                } catch (error) {
                    console.error('Error subscribing to project:', error);
                    updateFirebaseStatus('disconnected');
                }
            };

            // Auto-save functionality
            const scheduleAutoSave = useCallback(() => {
                if (!currentProject?.isFirebase) return;
                
                if (autoSaveTimeoutRef.current) {
                    clearTimeout(autoSaveTimeoutRef.current);
                }
                
                autoSaveTimeoutRef.current = setTimeout(async () => {
                    const projectData = {
                        collectionName,
                        modes,
                        variables: variables.map(v => ({
                            id: v.id,
                            name: v.name,
                            charLimit: v.charLimit,
                            values: { ...v.values }
                        })),
                        name: currentProject.name,
                        type: 'firebase'
                    };
                    
                    await saveToFirebase(projectData, currentProject.id);
                }, 10000); // Auto-save after 10 seconds of inactivity (less intrusive)
            }, [collectionName, modes, variables, currentProject]);

            // Trigger auto-save when data changes
            useEffect(() => {
                if (currentProject?.isFirebase) {
                    scheduleAutoSave();
                }
            }, [collectionName, modes, variables, scheduleAutoSave]);

            // Check if field is empty (for red border)
            const isFieldEmpty = (value) => {
                return !value || value.toString().trim() === '' || value === null || value === undefined;
            };

            // Get border class based on field content
            const getFieldBorderClass = (value) => {
                return isFieldEmpty(value) ? 'empty-field' : 'border-gray-200';
            };

            // Add new mode
            const addMode = () => {
                const newMode = prompt('New mode name (ex: FRA, ITA):');
                if (newMode && !modes.includes(newMode)) {
                    setModes([...modes, newMode]);
                    setVariables(variables.map(variable => ({
                        ...variable,
                        values: { ...variable.values, [newMode]: '' }
                    })));
                }
            };

            // Remove mode
            const removeMode = (modeToRemove) => {
                if (modes.length <= 1) return;
                setModes(modes.filter(mode => mode !== modeToRemove));
                setVariables(variables.map(variable => {
                    const newValues = { ...variable.values };
                    delete newValues[modeToRemove];
                    return { ...variable, values: newValues };
                }));
            };

            // Add new variable
            const addVariable = () => {
                const newVariable = {
                    id: Date.now().toString(),
                    name: `new-variable-${variables.length + 1}`,
                    values: modes.reduce((acc, mode) => ({ ...acc, [mode]: '' }), {}),
                    charLimit: 50
                };
                setVariables([...variables, newVariable]);
            };

            // Remove variable
            const removeVariable = (id) => {
                setVariables(variables.filter(v => v.id !== id));
            };

            // Update variable name
            const updateVariableName = (id, name) => {
                setVariables(variables.map(v => v.id === id ? { ...v, name } : v));
            };

            // Update variable value
            const updateVariableValue = (id, mode, value) => {
                setVariables(variables.map(v => 
                    v.id === id ? { 
                        ...v, 
                        values: { ...v.values, [mode]: value }
                    } : v
                ));
            };

            // Update character limit
            const updateLimit = (id, limit) => {
                setVariables(variables.map(v => 
                    v.id === id ? { 
                        ...v, 
                        charLimit: parseInt(limit) || 50
                    } : v
                ));
                setEditingLimit(null);
            };

            // Get character count color
            const getCountColor = (length, limit) => {
                const ratio = length / limit;
                if (ratio > 1) return 'text-red-500';
                if (ratio > 0.8) return 'text-yellow-600';
                return 'text-gray-500';
            };

            // Drag and drop handlers
            const handleDragStart = (e, index) => {
                setDraggedItem(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                if (draggedItem === null) return;

                const newVariables = [...variables];
                const draggedVariable = newVariables[draggedItem];
                newVariables.splice(draggedItem, 1);
                newVariables.splice(dropIndex, 0, draggedVariable);
                
                setVariables(newVariables);
                setDraggedItem(null);
            };

            // Export JSON
            const exportJSON = () => {
                setShowExportMenu(false);
                
                // Show export format selection
                const format = confirm('Choose export format:\n\nOK = Figma Compatible Format\nCancel = Standard Format\n\n(Figma format can be imported back to Figma)');
                
                try {
                    let jsonData;
                    let filename;
                    
                    if (format) {
                        // Figma compatible format
                        const modesData = {};
                        
                        modes.forEach(mode => {
                            modesData[mode] = {};
                            variables.forEach(variable => {
                                modesData[mode][variable.name] = {
                                    "$scopes": ["ALL_SCOPES"],
                                    "$type": "string",
                                    "$value": variable.values[mode] || ""
                                };
                            });
                        });
                        
                        jsonData = [{
                            [collectionName]: {
                                modes: modesData
                            }
                        }];
                        
                        filename = `${collectionName.toLowerCase().replace(/\s+/g, '-')}-figma.json`;
                    } else {
                        // Standard format (our internal format)
                        jsonData = {
                            collections: [{
                                name: collectionName,
                                modes: modes,
                                variables: variables.reduce((acc, variable) => {
                                    acc[variable.name] = {
                                        type: 'string',
                                        values: variable.values
                                    };
                                    return acc;
                                }, {})
                            }]
                        };
                        
                        filename = `${collectionName.toLowerCase().replace(/\s+/g, '-')}-standard.json`;
                    }

                    const jsonString = JSON.stringify(jsonData, null, 4);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                } catch (error) {
                    // Fallback - show in new window
                    const jsonData = {
                        collections: [{
                            name: collectionName,
                            modes: modes,
                            variables: variables.reduce((acc, variable) => {
                                acc[variable.name] = {
                                    type: 'string',
                                    values: variable.values
                                };
                                return acc;
                            }, {})
                        }]
                    };
                    
                    const jsonString = JSON.stringify(jsonData, null, 4);
                    const newWindow = window.open();
                    newWindow.document.write(`<pre>${jsonString}</pre>`);
                    newWindow.document.title = 'Variables JSON';
                    alert('JSON displayed in new window - copy the content');
                }
            };

            // Export to Excel
            const exportExcel = () => {
                try {
                    const wb = XLSX.utils.book_new();
                    const headers = ['Variable Name', 'Character Limit', ...modes];
                    const data = [headers];
                    
                    variables.forEach(variable => {
                        const row = [
                            variable.name,
                            variable.charLimit,
                            ...modes.map(mode => variable.values[mode] || '')
                        ];
                        data.push(row);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const colWidths = [
                        { wch: 25 },
                        { wch: 15 },
                        ...modes.map(() => ({ wch: 30 }))
                    ];
                    ws['!cols'] = colWidths;
                    
                    XLSX.utils.book_append_sheet(wb, ws, 'Variables');
                    XLSX.writeFile(wb, `${collectionName.toLowerCase().replace(/\s+/g, '-')}.xlsx`);
                    
                } catch (error) {
                    alert('Error exporting Excel: ' + error.message);
                }
                setShowExportMenu(false);
            };

            // Import from Excel
            const importExcel = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        const worksheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[worksheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            alert('Excel file must have at least one header row and one data row');
                            return;
                        }
                        
                        const headers = jsonData[0];
                        const languageCols = headers.slice(2);
                        
                        if (!headers[0] || !headers[1] || languageCols.length === 0) {
                            alert('Incorrect format. Must have: Variable Name, Character Limit, and at least one language');
                            return;
                        }
                        
                        setModes(languageCols);
                        
                        const newVariables = jsonData.slice(1).map((row, index) => {
                            if (!row[0]) return null;
                            
                            const values = {};
                            languageCols.forEach((lang, langIndex) => {
                                values[lang] = row[2 + langIndex] || '';
                            });
                            
                            return {
                                id: index.toString(),
                                name: row[0] || `variable-${index + 1}`,
                                charLimit: parseInt(row[1]) || 50,
                                values
                            };
                        }).filter(Boolean);
                        
                        setVariables(newVariables);
                        setCurrentProject(null);
                        alert('Excel imported successfully!');
                        
                    } catch (error) {
                        alert('Error importing Excel: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = '';
                setShowImportMenu(false);
            };

            // Save to Firebase as new project OR update current
            const saveToFirebaseProject = async (forceNew = false) => {
                // If we have a current Firebase project and name hasn't changed and not forcing new
                if (currentProject?.isFirebase && !forceNew && collectionName === currentProject.name) {
                    const projectData = {
                        name: currentProject.name,
                        collectionName,
                        modes,
                        variables: variables.map(v => ({
                            id: v.id,
                            name: v.name,
                            charLimit: v.charLimit,
                            values: { ...v.values }
                        })),
                        type: 'firebase',
                        createdAt: currentProject.createdAt
                    };

                    const projectId = await saveToFirebase(projectData, currentProject.id);
                    
                    if (projectId) {
                        alert(`Project "${currentProject.name}" updated in Firebase!`);
                    }
                    return;
                }

                // For new projects or "Save As", we need a name
                const finalProjectName = projectName.trim() || collectionName || 'New Project';
                
                if (!finalProjectName) {
                    alert('Please enter a project name');
                    return;
                }

                const projectData = {
                    name: finalProjectName,
                    collectionName,
                    modes,
                    variables: variables.map(v => ({
                        id: v.id,
                        name: v.name,
                        charLimit: v.charLimit,
                        values: { ...v.values }
                    })),
                    type: 'firebase',
                    createdAt: new Date().toISOString()
                };

                const projectId = await saveToFirebase(projectData);
                
                if (projectId) {
                    const newProject = {
                        ...projectData,
                        id: projectId,
                        isFirebase: true
                    };
                    
                    setCurrentProject(newProject);
                    subscribeToProject(projectId);
                    
                    setProjectName('');
                    setShowProjectModal(false);
                    
                    alert(`Project "${projectData.name}" saved to Firebase!`);
                }
            };

            // Handle Save Cloud button click
            const handleSaveCloud = () => {
                // If we have a current Firebase project and collection name hasn't changed
                if (currentProject?.isFirebase && collectionName === currentProject.name) {
                    // Direct save without modal
                    saveToFirebaseProject();
                } else {
                    // Show modal for new name or new project
                    setProjectName(collectionName || currentProject?.name || '');
                    setShowProjectModal(true);
                }
            };

            // Share project (Firebase version)
            const shareProject = async () => {
                let projectId = currentProject?.id;
                
                // If no current Firebase project, save first
                if (!currentProject?.isFirebase) {
                    const projectData = {
                        name: collectionName || 'Proyecto compartido',
                        collectionName,
                        modes,
                        variables: variables.map(v => ({
                            id: v.id,
                            name: v.name,
                            charLimit: v.charLimit,
                            values: { ...v.values }
                        })),
                        type: 'firebase',
                        createdAt: new Date().toISOString()
                    };

                    projectId = await saveToFirebase(projectData);
                    
                    if (projectId) {
                        const newProject = {
                            ...projectData,
                            id: projectId,
                            isFirebase: true
                        };
                        
                        setCurrentProject(newProject);
                        subscribeToProject(projectId);
                    }
                }
                
                if (projectId) {
                    const shareLink = `${window.location.origin}${window.location.pathname}?project=${projectId}`;
                    setShareableLink(shareLink);
                    setShowShareModal(true);
                } else {
                    alert('Error generando el link compartible');
                }
            };

            // Copy share link
            const copyShareLink = async () => {
                try {
                    await navigator.clipboard.writeText(shareableLink);
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 2000);
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = shareableLink;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 2000);
                }
            };

            // Load saved data on component mount
            useEffect(() => {
                const savedTemplatesData = localStorage.getItem('figma-templates');
                if (savedTemplatesData) {
                    setSavedTemplates(JSON.parse(savedTemplatesData));
                }
                
                const savedProjectsData = localStorage.getItem('figma-projects');
                if (savedProjectsData) {
                    setSavedProjects(JSON.parse(savedProjectsData));
                }

                // Check for shared Firebase project
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('project');
                
                if (projectId && db) {
                    loadFromFirebase(projectId).then(projectData => {
                        if (projectData) {
                            setCollectionName(projectData.collectionName || 'Languages');
                            setModes(projectData.modes || ['SPA', 'POR', 'ENG']);
                            
                            const newVariables = projectData.variables ? projectData.variables.map((v, index) => ({
                                ...v,
                                id: v.id || index.toString()
                            })) : [];
                            
                            setVariables(newVariables);
                            
                            setCurrentProject({
                                ...projectData,
                                isFirebase: true
                            });
                            
                            subscribeToProject(projectId);
                            
                            // Clear URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                            
                            setTimeout(() => {
                                alert('¡Proyecto Firebase cargado! Los cambios se sincronizan en tiempo real.');
                            }, 1000);
                        } else {
                            alert('No se pudo cargar el proyecto compartido');
                        }
                    });
                }

                // Check Firebase connection
                const checkFirebase = () => {
                    if (db) {
                        updateFirebaseStatus('connected');
                    } else {
                        setTimeout(checkFirebase, 1000);
                    }
                };
                checkFirebase();

                // Cleanup subscription on unmount
                return () => {
                    if (unsubscribeRef.current) {
                        unsubscribeRef.current();
                    }
                    if (autoSaveTimeoutRef.current) {
                        clearTimeout(autoSaveTimeoutRef.current);
                    }
                };
            }, []);

            // Standard save functions (for local projects)
            const saveCurrentProject = () => {
                if (!currentProject) return;

                if (currentProject.isFirebase) {
                    // Firebase projects auto-save, just show confirmation
                    alert('¡Proyecto sincronizado con Firebase!');
                    return;
                }

                // Local project saving logic (original)
                const updatedProject = {
                    ...currentProject,
                    collectionName,
                    modes,
                    variables: variables.map(v => ({
                        name: v.name,
                        charLimit: v.charLimit,
                        values: { ...v.values }
                    })),
                    updatedAt: new Date().toLocaleDateString()
                };

                if (currentProject.type === 'project') {
                    const updatedProjects = savedProjects.map(p => p.id === currentProject.id ? updatedProject : p);
                    setSavedProjects(updatedProjects);
                    localStorage.setItem('figma-projects', JSON.stringify(updatedProjects));
                } else {
                    const updatedTemplates = savedTemplates.map(t => t.id === currentProject.id ? updatedProject : t);
                    setSavedTemplates(updatedTemplates);
                    localStorage.setItem('figma-templates', JSON.stringify(updatedTemplates));
                }

                setCurrentProject(updatedProject);
                alert(`${currentProject.type === 'template' ? 'Template' : 'Proyecto'} "${currentProject.name}" actualizado!`);
            };

            // Save as template (structure only)
            const saveTemplate = () => {
                if (!templateName.trim()) {
                    alert('Por favor ingresa un nombre para el template');
                    return;
                }

                const existingTemplate = savedTemplates.find(t => t.name === templateName);
                
                if (existingTemplate) {
                    const shouldOverwrite = confirm(`Ya existe un template llamado "${templateName}". ¿Quieres sobreescribirlo?`);
                    if (!shouldOverwrite) {
                        return;
                    }
                }

                const template = {
                    id: existingTemplate ? existingTemplate.id : Date.now().toString(),
                    name: templateName,
                    type: 'template',
                    collectionName,
                    modes,
                    variables: variables.map(v => ({
                        name: v.name,
                        charLimit: v.charLimit,
                        values: Object.keys(v.values).reduce((acc, mode) => ({ ...acc, [mode]: '' }), {})
                    })),
                    createdAt: existingTemplate ? existingTemplate.createdAt : new Date().toLocaleDateString(),
                    updatedAt: new Date().toLocaleDateString()
                };

                let updatedTemplates;
                if (existingTemplate) {
                    updatedTemplates = savedTemplates.map(t => t.id === existingTemplate.id ? template : t);
                } else {
                    updatedTemplates = [...savedTemplates, template];
                }

                setSavedTemplates(updatedTemplates);
                localStorage.setItem('figma-templates', JSON.stringify(updatedTemplates));
                
                setTemplateName('');
                setShowTemplateModal(false);
                
                alert(`Template "${template.name}" ${existingTemplate ? 'actualizado' : 'guardado'} exitosamente!`);
            };

            // Save as project (local version)
            const saveProject = () => {
                if (!projectName.trim()) {
                    alert('Por favor ingresa un nombre para el proyecto');
                    return;
                }

                const existingProject = savedProjects.find(p => p.name === projectName);
                
                if (existingProject) {
                    const shouldOverwrite = confirm(`Ya existe un proyecto llamado "${projectName}". ¿Quieres sobreescribirlo?`);
                    if (!shouldOverwrite) {
                        return;
                    }
                }

                const project = {
                    id: existingProject ? existingProject.id : Date.now().toString(),
                    name: projectName,
                    type: 'project',
                    collectionName,
                    modes,
                    variables: variables.map(v => ({
                        name: v.name,
                        charLimit: v.charLimit,
                        values: { ...v.values }
                    })),
                    createdAt: existingProject ? existingProject.createdAt : new Date().toLocaleDateString(),
                    updatedAt: new Date().toLocaleDateString()
                };

                let updatedProjects;
                if (existingProject) {
                    updatedProjects = savedProjects.map(p => p.id === existingProject.id ? project : p);
                } else {
                    updatedProjects = [...savedProjects, project];
                }

                setSavedProjects(updatedProjects);
                localStorage.setItem('figma-projects', JSON.stringify(updatedProjects));
                
                setCurrentProject(project);
                setProjectName('');
                setShowProjectModal(false);
                
                alert(`Proyecto "${project.name}" ${existingProject ? 'actualizado' : 'guardado'} exitosamente!`);
            };

            // Load item (template or project)
            const loadItem = (item) => {
                // Unsubscribe from current Firebase project if any
                if (unsubscribeRef.current) {
                    unsubscribeRef.current();
                    unsubscribeRef.current = null;
                }

                setCollectionName(item.collectionName);
                setModes(item.modes);
                
                const newVariables = item.variables.map((v, index) => ({
                    ...v,
                    id: v.id || index.toString(),
                    values: item.modes.reduce((acc, mode) => ({
                        ...acc,
                        [mode]: v.values[mode] || ''
                    }), {})
                }));
                
                setVariables(newVariables);
                setCurrentProject(item);
                
                alert(`${item.type === 'template' ? 'Template' : 'Proyecto'} "${item.name}" cargado!`);
            };

            // Delete item
            const deleteItem = (itemId, type) => {
                if (confirm(`¿Estás seguro de eliminar este ${type === 'template' ? 'template' : 'proyecto'}?`)) {
                    if (type === 'template') {
                        const updatedTemplates = savedTemplates.filter(t => t.id !== itemId);
                        setSavedTemplates(updatedTemplates);
                        localStorage.setItem('figma-templates', JSON.stringify(updatedTemplates));
                    } else {
                        const updatedProjects = savedProjects.filter(p => p.id !== itemId);
                        setSavedProjects(updatedProjects);
                        localStorage.setItem('figma-projects', JSON.stringify(updatedProjects));
                    }
                    
                    if (currentProject && currentProject.id === itemId) {
                        setCurrentProject(null);
                    }
                }
            };

            // Import JSON
            const importJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        const collection = data.collections[0];
                        
                        setCollectionName(collection.name);
                        setModes(collection.modes);
                        
                        const newVariables = Object.entries(collection.variables).map(([name, variable], index) => ({
                            id: index.toString(),
                            name,
                            values: collection.modes.reduce((acc, mode) => ({
                                ...acc,
                                [mode]: variable.values[mode] || ''
                            }), {}),
                            charLimit: 50
                        }));
                        
                        setVariables(newVariables);
                        setCurrentProject(null);
                        alert('JSON importado exitosamente!');
                    } catch (error) {
                        alert('Error al importar JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
                setShowImportMenu(false);
            };

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                            {/* Title Row */}
                            <div className="flex items-center gap-4 mb-6">
                                <input
                                    type="text"
                                    value={collectionName}
                                    onChange={(e) => setCollectionName(e.target.value)}
                                    className="text-2xl font-semibold text-gray-900 bg-transparent border-none outline-none focus:bg-gray-50 rounded px-2 py-1"
                                />
                                {currentProject && (
                                    <div className={`flex items-center gap-2 px-3 py-1 rounded-full text-sm ${
                                        currentProject.isFirebase 
                                            ? 'bg-green-50 text-green-700 border border-green-200' 
                                            : 'bg-blue-50 text-blue-700'
                                    }`}>
                                        <span>{currentProject.isFirebase ? '🌐' : (currentProject.type === 'template' ? '📋' : '💾')}</span>
                                        <span>
                                            {currentProject.isFirebase ? 'Firebase:' : 'Editando:'} <strong>{currentProject.name}</strong>
                                        </span>
                                        {currentProject.isFirebase && lastSaved && (
                                            <span className="text-xs opacity-75">
                                                • {lastSaved}
                                            </span>
                                        )}
                                    </div>
                                )}
                            </div>
                            
                            {/* Toolbar Row */}
                            <div className="flex gap-2 flex-wrap">
                                {/* Open Local */}
                                <button
                                    onClick={() => setShowOpenModal(true)}
                                    className="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                >
                                    <FolderOpen size={16} />
                                    Open Local
                                </button>

                                {/* Save Local */}
                                <button
                                    onClick={currentProject?.isFirebase ? saveCurrentProject : (currentProject ? saveCurrentProject : () => setShowProjectModal(true))}
                                    className={`flex items-center gap-2 px-3 py-2 text-sm rounded-md transition-colors ${
                                        currentProject?.isFirebase
                                            ? 'bg-green-600 text-white hover:bg-green-700' 
                                            : (currentProject 
                                                ? 'bg-blue-600 text-white hover:bg-blue-700' 
                                                : 'bg-gray-600 text-white hover:bg-gray-700')
                                    }`}
                                    title={currentProject?.isFirebase 
                                        ? 'Project synced automatically' 
                                        : (currentProject ? `Save changes to "${currentProject.name}"` : 'Save as new local project')}
                                >
                                    <Save size={16} />
                                    {currentProject?.isFirebase 
                                        ? 'Synced'
                                        : (currentProject ? 'Save Local' : 'Save Local')}
                                </button>

                                {/* Open Cloud */}
                                <button
                                    onClick={openFirebaseProjects}
                                    className="flex items-center gap-2 px-3 py-2 text-sm text-green-600 border border-green-300 rounded-md hover:bg-green-50 transition-colors"
                                >
                                    <Cloud size={16} />
                                    Open Cloud
                                </button>

                                {/* Save Cloud */}
                                <button
                                    onClick={handleSaveCloud}
                                    className="flex items-center gap-2 px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                                    title={currentProject?.isFirebase && collectionName === currentProject.name 
                                        ? `Update "${currentProject.name}" in Firebase` 
                                        : "Save to Firebase (new project or save as)"}
                                >
                                    <Cloud size={16} />
                                    {currentProject?.isFirebase && collectionName === currentProject.name 
                                        ? 'Update Cloud' 
                                        : 'Save Cloud'}
                                </button>

                                {/* Load Template */}
                                <button
                                    onClick={() => setShowOpenTemplateModal(true)}
                                    className="flex items-center gap-2 px-3 py-2 text-sm text-purple-600 border border-purple-300 rounded-md hover:bg-purple-50 transition-colors"
                                >
                                    <Settings size={16} />
                                    Load Template
                                </button>

                                {/* Save Template */}
                                <button
                                    onClick={() => setShowTemplateModal(true)}
                                    className="flex items-center gap-2 px-3 py-2 text-sm bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors"
                                >
                                    <Settings size={16} />
                                    Save Template
                                </button>

                                {/* Share */}
                                <button
                                    onClick={shareProject}
                                    className="flex items-center gap-2 px-3 py-2 text-sm bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors"
                                >
                                    <Share size={16} />
                                    Share
                                </button>

                                {/* Import Dropdown */}
                                <div className="relative">
                                    <button
                                        onClick={() => setShowImportMenu(!showImportMenu)}
                                        className="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                    >
                                        <Upload size={16} />
                                        Import
                                        <ChevronDown size={14} />
                                    </button>
                                    {showImportMenu && (
                                        <div className="absolute right-0 top-full mt-1 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-10">
                                            <button
                                                onClick={() => fileInputRef.current?.click()}
                                                className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                                            >
                                                📄 Import JSON
                                            </button>
                                            <button
                                                onClick={() => excelInputRef.current?.click()}
                                                className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                                            >
                                                📊 Import Excel/Numbers
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* Export Dropdown */}
                                <div className="relative">
                                    <button
                                        onClick={() => setShowExportMenu(!showExportMenu)}
                                        className="flex items-center gap-2 px-3 py-2 text-sm bg-gray-900 text-white rounded-md hover:bg-gray-800 transition-colors"
                                    >
                                        <Download size={16} />
                                        Export
                                        <ChevronDown size={14} />
                                    </button>
                                    {showExportMenu && (
                                        <div className="absolute right-0 top-full mt-1 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-10">
                                            <button
                                                onClick={exportJSON}
                                                className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                                            >
                                                📄 Export JSON
                                            </button>
                                            <button
                                                onClick={exportExcel}
                                                className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                                            >
                                                📊 Export Excel/Numbers
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Hidden file inputs */}
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".json"
                                onChange={importJSON}
                                className="hidden"
                            />
                            <input
                                ref={excelInputRef}
                                type="file"
                                accept=".xlsx,.xls"
                                onChange={importExcel}
                                className="hidden"
                            />
                        </div>

                        {/* Table - Same as before */}
                        <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50 border-b border-gray-200">
                                        <tr>
                                            <th className="w-8 px-4 py-3"></th>
                                            <th className="text-left px-4 py-3 text-sm font-medium text-gray-900 min-w-48">
                                                Variable Name
                                            </th>
                                            {modes.map(mode => (
                                                <th key={mode} className="text-left px-4 py-3 text-sm font-medium text-gray-900 min-w-64 relative group">
                                                    <div className="flex items-center justify-between">
                                                        <span>{mode}</span>
                                                        {modes.length > 1 && (
                                                            <button
                                                                onClick={() => removeMode(mode)}
                                                                className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition-all"
                                                            >
                                                                <Trash2 size={14} />
                                                            </button>
                                                        )}
                                                    </div>
                                                </th>
                                            ))}
                                            <th className="w-16 px-4 py-3">
                                                <button
                                                    onClick={addMode}
                                                    className="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded transition-colors"
                                                >
                                                    <Plus size={16} />
                                                </button>
                                            </th>
                                            <th className="w-16 px-4 py-3"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {variables.map((variable, index) => (
                                            <tr
                                                key={variable.id}
                                                className="border-b border-gray-100 hover:bg-gray-50 transition-colors"
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, index)}
                                                onDragOver={handleDragOver}
                                                onDrop={(e) => handleDrop(e, index)}
                                            >
                                                <td className="px-4 py-3">
                                                    <div className="cursor-move text-gray-400 hover:text-gray-600">
                                                        <GripVertical size={16} />
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <input
                                                        type="text"
                                                        value={variable.name || ''}
                                                        onChange={(e) => updateVariableName(variable.id, e.target.value)}
                                                        className={`w-full px-3 py-2 text-sm font-bold border rounded focus:outline-none focus:ring-2 focus:ring-gray-300 ${getFieldBorderClass(variable.name)}`}
                                                        placeholder="variable-name"
                                                    />
                                                </td>
                                                {modes.map((mode, modeIndex) => (
                                                    <td key={mode} className="px-4 py-3">
                                                        <div className="space-y-2">
                                                            <textarea
                                                                value={variable.values[mode] || ''}
                                                                onChange={(e) => updateVariableValue(variable.id, mode, e.target.value)}
                                                                className={`w-full px-3 py-2 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-gray-300 resize-none ${getFieldBorderClass(variable.values[mode])}`}
                                                                rows="2"
                                                                placeholder={`Text in ${mode}`}
                                                            />
                                                            <div className="flex items-center justify-between text-xs">
                                                                <span className={getCountColor(
                                                                    (variable.values[mode] || '').length,
                                                                    variable.charLimit
                                                                )}>
                                                                    {(variable.values[mode] || '').length}/{variable.charLimit}
                                                                </span>
                                                                {modeIndex === 0 && (
                                                                    editingLimit === variable.id ? (
                                                                        <input
                                                                            type="number"
                                                                            defaultValue={variable.charLimit}
                                                                            onBlur={(e) => updateLimit(variable.id, e.target.value)}
                                                                            onKeyDown={(e) => {
                                                                                if (e.key === 'Enter') {
                                                                                    updateLimit(variable.id, e.target.value);
                                                                                }
                                                                            }}
                                                                            className="w-16 px-1 py-0 text-xs border border-gray-300 rounded"
                                                                            autoFocus
                                                                        />
                                                                    ) : (
                                                                        <button
                                                                            onClick={() => setEditingLimit(variable.id)}
                                                                            className="text-gray-400 hover:text-gray-600"
                                                                            title="Edit character limit"
                                                                        >
                                                                            <Settings size={12} />
                                                                        </button>
                                                                    )
                                                                )}
                                                            </div>
                                                        </div>
                                                    </td>
                                                ))}
                                                <td className="px-4 py-3"></td>
                                                <td className="px-4 py-3">
                                                    <button
                                                        onClick={() => removeVariable(variable.id)}
                                                        className="text-gray-400 hover:text-red-500 transition-colors"
                                                    >
                                                        <Trash2 size={16} />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="border-t border-gray-200 p-4">
                                <button
                                    onClick={addVariable}
                                    className="flex items-center gap-2 px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                >
                                    <Plus size={16} />
                                    Add new variable
                                </button>
                            </div>
                        </div>

                        <div className="mt-6 text-center text-sm text-gray-500">
                            Edye Variable Editor v6.2 - Improved Cloud Save
                        </div>

                        {/* Open Firebase Projects Modal */}
                        {showOpenFirebaseModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-6 w-[600px] mx-4 max-h-[80vh] overflow-y-auto">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">🌐 Firebase Projects</h3>
                                        <button
                                            onClick={() => setShowOpenFirebaseModal(false)}
                                            className="text-gray-400 hover:text-gray-600"
                                        >
                                            <X size={20} />
                                        </button>
                                    </div>
                                    
                                    {firebaseProjects.length === 0 ? (
                                        <div className="text-center py-8">
                                            <div className="text-4xl mb-4">🌐</div>
                                            <p className="text-gray-500 mb-4">No projects in Firebase</p>
                                            <button
                                                onClick={() => {
                                                    setShowOpenFirebaseModal(false);
                                                    setShowProjectModal(true);
                                                }}
                                                className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                                            >
                                                <Cloud size={16} className="inline mr-2" />
                                                Create first Firebase project
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {firebaseProjects.map(project => (
                                                <div key={project.id} className="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200 hover:bg-green-100 transition-colors">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="text-green-600">🌐</span>
                                                            <span className="font-medium text-gray-900">{project.name}</span>
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            <span className="mr-4">
                                                                📊 {project.variables?.length || 0} variables
                                                            </span>
                                                            <span className="mr-4">
                                                                🗣️ {project.modes?.length || 0} languages
                                                            </span>
                                                            {project.updatedAt && (
                                                                <span>
                                                                    📅 {new Date(project.updatedAt).toLocaleDateString('en-US', {
                                                                        day: '2-digit',
                                                                        month: '2-digit',
                                                                        year: 'numeric',
                                                                        hour: '2-digit',
                                                                        minute: '2-digit'
                                                                    })}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 ml-4">
                                                        <button
                                                            onClick={() => loadFirebaseProject(project)}
                                                            className="px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                                                        >
                                                            Open
                                                        </button>
                                                        <button
                                                            onClick={() => deleteFirebaseProject(project.id)}
                                                            className="px-3 py-2 text-sm text-red-600 border border-red-300 rounded-md hover:bg-red-50 transition-colors"
                                                        >
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    <div className="mt-6 pt-4 border-t border-gray-200">
                                        <div className="flex gap-3">
                                            <button
                                                onClick={() => {
                                                    setShowOpenFirebaseModal(false);
                                                    setShowProjectModal(true);
                                                }}
                                                className="flex items-center gap-2 px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                                            >
                                                <Cloud size={16} />
                                                New Firebase Project
                                            </button>
                                            <button
                                                onClick={async () => {
                                                    const projects = await loadAllFirebaseProjects();
                                                    setFirebaseProjects(projects);
                                                }}
                                                className="flex items-center gap-2 px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                            >
                                                🔄 Refresh
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Firebase Share Modal */}
                        {showShareModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-6 w-[500px] mx-4 max-h-[80vh] overflow-y-auto">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">🌐 Compartir Proyecto Firebase</h3>
                                        <button
                                            onClick={() => {
                                                setShowShareModal(false);
                                                setCopySuccess(false);
                                            }}
                                            className="text-gray-400 hover:text-gray-600"
                                        >
                                            <X size={20} />
                                        </button>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Link Compartible
                                        </label>
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={shareableLink}
                                                readOnly
                                                className="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md bg-gray-50 font-mono"
                                            />
                                            <button
                                                onClick={copyShareLink}
                                                className={`px-3 py-2 text-sm rounded-md transition-colors ${
                                                    copySuccess 
                                                        ? 'bg-green-600 text-white' 
                                                        : 'bg-blue-600 text-white hover:bg-blue-700'
                                                }`}
                                            >
                                                {copySuccess ? '✓' : <Copy size={16} />}
                                            </button>
                                        </div>
                                        {copySuccess && (
                                            <p className="text-sm text-green-600 mt-2">¡Link copiado al portapapeles!</p>
                                        )}
                                    </div>
                                    
                                    <div className="text-sm text-gray-600 mb-4 bg-green-50 p-3 rounded">
                                        <p className="font-medium mb-1">🌐 Colaboración en tiempo real</p>
                                        <ul className="list-disc list-inside ml-2 space-y-1">
                                            <li><strong>Sincronización automática:</strong> Los cambios aparecen instantáneamente</li>
                                            <li><strong>Múltiples usuarios:</strong> Pueden editar simultáneamente</li>
                                            <li><strong>Sin pérdida de datos:</strong> Todo se guarda automáticamente</li>
                                            <li><strong>Links cortos:</strong> Fáciles de compartir</li>
                                        </ul>
                                    </div>
                                    
                                    <div className="flex gap-3 justify-end">
                                        <button
                                            onClick={() => {
                                                setShowShareModal(false);
                                                setCopySuccess(false);
                                            }}
                                            className="px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                        >
                                            Cerrar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Firebase Project Modal */}
                        {showProjectModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-6 w-96 mx-4">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">🌐 Guardar en Firebase</h3>
                                        <button
                                            onClick={() => {
                                                setShowProjectModal(false);
                                                setProjectName('');
                                            }}
                                            className="text-gray-400 hover:text-gray-600"
                                        >
                                            <X size={20} />
                                        </button>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Nombre del Proyecto
                                        </label>
                                        <input
                                            type="text"
                                            value={projectName}
                                            onChange={(e) => setProjectName(e.target.value)}
                                            placeholder="ej: Campaign Q1 2024"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                            autoFocus
                                        />
                                    </div>
                                    
                                    <div className="text-sm text-gray-600 mb-4 bg-green-50 p-3 rounded">
                                        <p className="font-medium mb-1">Firebase = Colaboración en tiempo real</p>
                                        <ul className="list-disc list-inside ml-2 space-y-1">
                                            <li><strong>Sincronización automática</strong> entre todos los usuarios</li>
                                            <li><strong>Links compartibles</strong> simples y cortos</li>
                                            <li><strong>Sin límite de colaboradores</strong></li>
                                            <li><strong>Guardado automático</strong> cada 2 segundos</li>
                                        </ul>
                                    </div>
                                    
                                    <div className="flex gap-3 justify-end">
                                        <button
                                            onClick={() => {
                                                setShowProjectModal(false);
                                                setProjectName('');
                                            }}
                                            className="px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            onClick={currentProject?.isFirebase ? saveCurrentProject : saveToFirebaseProject}
                                            className="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                                        >
                                            🌐 Guardar en Firebase
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Local modals unchanged... */}
                        {showOpenModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-6 w-96 mx-4 max-h-96 overflow-y-auto">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">💾 Abrir Proyecto Local</h3>
                                        <button
                                            onClick={() => setShowOpenModal(false)}
                                            className="text-gray-400 hover:text-gray-600"
                                        >
                                            <X size={20} />
                                        </button>
                                    </div>
                                    
                                    {savedProjects.length === 0 ? (
                                        <p className="text-gray-500 text-center py-4">No hay proyectos locales guardados</p>
                                    ) : (
                                        <div className="space-y-2">
                                            {savedProjects.map(project => (
                                                <div key={project.id} className="flex items-center justify-between p-3 bg-blue-50 rounded border hover:bg-blue-100 transition-colors">
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-900">💾 {project.name}</div>
                                                        <div className="text-sm text-gray-500">
                                                            {project.updatedAt ? `Actualizado: ${project.updatedAt}` : project.createdAt}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => {
                                                                loadItem(project);
                                                                setShowOpenModal(false);
                                                            }}
                                                            className="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
                                                        >
                                                            Abrir
                                                        </button>
                                                        <button
                                                            onClick={() => deleteItem(project.id, 'project')}
                                                            className="px-2 py-1 text-sm text-red-600 hover:text-red-800"
                                                        >
                                                            ×
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {showOpenTemplateModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-6 w-96 mx-4 max-h-96 overflow-y-auto">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">📋 Abrir Template</h3>
                                        <button
                                            onClick={() => setShowOpenTemplateModal(false)}
                                            className="text-gray-400 hover:text-gray-600"
                                        >
                                            <X size={20} />
                                        </button>
                                    </div>
                                    
                                    {savedTemplates.length === 0 ? (
                                        <p className="text-gray-500 text-center py-4">No hay templates guardados</p>
                                    ) : (
                                        <div className="space-y-2">
                                            {savedTemplates.map(template => (
                                                <div key={template.id} className="flex items-center justify-between p-3 bg-purple-50 rounded border hover:bg-purple-100 transition-colors">
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-900">📋 {template.name}</div>
                                                        <div className="text-sm text-gray-500">
                                                            {template.updatedAt ? `Actualizado: ${template.updatedAt}` : template.createdAt}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => {
                                                                loadItem(template);
                                                                setShowOpenTemplateModal(false);
                                                            }}
                                                            className="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700"
                                                        >
                                                            Usar
                                                        </button>
                                                        <button
                                                            onClick={() => deleteItem(template.id, 'template')}
                                                            className="px-2 py-1 text-sm text-red-600 hover:text-red-800"
                                                        >
                                                            ×
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {showTemplateModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-6 w-96 mx-4">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">📋 Guardar como Template</h3>
                                        <button
                                            onClick={() => {
                                                setShowTemplateModal(false);
                                                setTemplateName('');
                                            }}
                                            className="text-gray-400 hover:text-gray-600"
                                        >
                                            <X size={20} />
                                        </button>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Nombre del Template
                                        </label>
                                        <input
                                            type="text"
                                            value={templateName}
                                            onChange={(e) => setTemplateName(e.target.value)}
                                            placeholder="ej: Landing Page Structure"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            autoFocus
                                        />
                                    </div>
                                    
                                    <div className="text-sm text-gray-600 mb-4 bg-purple-50 p-3 rounded">
                                        <p className="font-medium mb-1">Template = Solo estructura</p>
                                        <ul className="list-disc list-inside ml-2 space-y-1">
                                            <li>Variables y configuración de límites</li>
                                            <li>Idiomas/modos configurados</li>
                                            <li><strong>Textos se vacían</strong> (reutilizable)</li>
                                        </ul>
                                    </div>
                                    
                                    <div className="flex gap-3 justify-end">
                                        <button
                                            onClick={() => {
                                                setShowTemplateModal(false);
                                                setTemplateName('');
                                            }}
                                            className="px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            onClick={saveTemplate}
                                            className="px-4 py-2 text-sm bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors"
                                        >
                                            Guardar Template
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<FigmaVariablesEditor />, document.getElementById('root'));
    </script>
</body>
</html>
